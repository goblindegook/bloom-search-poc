import{x as p,r as E}from"./xxh64-u64-498173eb.js";function L(r){return[...new Set(r)]}function B(r){return Array.isArray(r)}function F(r,e,s=[]){const[t,i]=B(e)?[1,e]:[e,s];if(r<=0)throw Error("size must be a positive integer");if(t<=0)throw Error("step must be a positive integer");if(i.length&&i.length<=r)return[[...i]];const n=i.length-r,h=[];let o=0;for(;o<=n;)h.push(i.slice(o,o+r)),o=o+t;return h}class R{constructor(e){if(this.pointers=new Map,this.cacheSize=0,this.head=0,this.tail=0,!Number.isInteger(e)||e<=0)throw new Error("Capacity must be a positive integer");this.capacity=e,this.keys=new Array(e),this.values=new Array(e),this.before=new Uint32Array(e),this.after=new Uint32Array(e)}get size(){return this.cacheSize}get(e){const s=this.pointers.get(e);if(s!==void 0)return this.recordAccess(s),this.values[s]}has(e){return this.pointers.has(e)}set(e,s){let t=this.pointers.get(e);if(t!==void 0){this.recordAccess(t),this.values[t]=s;return}this.cacheSize<this.capacity?t=this.cacheSize++:t=this.evict(),this.pointers.set(e,t),this.keys[t]=e,this.values[t]=s,this.after[t]=this.head,this.before[this.head]=t,this.head=t}delete(e){this.pointers.delete(e)}clear(){this.cacheSize=0,this.head=0,this.tail=0,this.pointers.clear()}recordAccess(e){if(this.head===e)return;const s=this.before[e],t=this.after[e];this.tail===e?this.tail=s:this.before[t]=s,this.after[s]=t,this.after[e]=this.head,this.head=e}evict(){const e=this.tail;return this.tail=this.before[e],this.pointers.delete(this.keys[e]),e}}function k(r,e,s={}){const t=s.capacity?new R(s.capacity):new Map;return Object.assign((...n)=>{const h=r(...n);return t.has(h)||t.set(h,e(...n)),t.get(h)},{clear:()=>t.clear()})}function x(r){return Number.parseInt(r.substring(8,16),16)}function T(r){const e=p(r+1),s=p(r+2);return k((t,i)=>`${String(t)}:${i}`,(t,i)=>{const n=x(e.update(i).digest("hex")),h=x(s.update(i).digest("hex"));return n+t*h+t**3})}class S{constructor(e){var s,t,i;if(e.size<1)throw Error("size must be greater than 0");if(e.hashes<1)throw Error("number of hashes must be greater than 0");this.size=e.size,this.hashes=e.hashes,this.seed=(s=e.seed)!==null&&s!==void 0?s:12648430,this.filter=(t=e.filter)!==null&&t!==void 0?t:new Uint32Array(Math.ceil(this.size/32)),this.hash=(i=e.hash)!==null&&i!==void 0?i:T(this.seed)}add(e){const s=e.toString();for(let t=0;t<this.hashes;t++){const i=this.hash(t,s)%this.size,n=Math.floor(i/32);this.filter[n]|=1<<i%32}}has(e){const s=e.toString();for(let t=0;t<this.hashes;t++){const i=this.hash(t,s)%this.size,n=Math.floor(i/32);if(!(this.filter[n]&1<<i%32))return!1}return!0}toJSON(){return{filter:Array.from(this.filter),hashes:this.hashes,seed:this.seed,size:this.size}}}function j(r,e){const s=Math.ceil(-(r*Math.log(e))/Math.LN2**2),t=Math.round(s/r*Math.LN2);return{size:s,hashes:t}}function N(r,e){if(typeof r.findLast=="function")return r.findLast(e);let s=r.length-1;for(;s>=0;){const t=r[s];if(e(t))return t;s--}}const w=r=>Object.keys(r),v=r=>Object.entries(r);function U(r,e){return r.reduce((s,t)=>(s[t]=e[t],s),{})}const O=Symbol("normal"),b=Symbol("exclude"),z=Symbol("phrase"),A=Symbol("require"),C=r=>r.replace(/\s+/g,"_"),I=r=>r.replace(/_+/g," "),$=r=>r.replace(/(^\+|^-|^"|"$)/g,"");function W(r){return r.replace(/"[^"]+"/g,C).split(/\s/).map(e=>[$(I(e)).toLowerCase(),e.startsWith('"')?z:e.startsWith("+")?A:e.startsWith("-")?b:O]).filter(([e])=>e.length)}function D(r,e,s){const t=1+e.filter(i=>i[r]>0).length;return 1+Math.log(s/t)}function H(r,e,s){return v(r).reduce((t,[i,n])=>{const h=D(i,e,s);return t+n*h},0)}const P=(r,e)=>r===e?0:r>e?-1:1,Q=r=>r.normalize("NFD").toLowerCase().split(/[\s-]+/).map(e=>e.replace(/\W/gi,"")),_=r=>k(String,e=>Number.parseInt(r.update(e).digest("hex").substring(8,16),16));class J{constructor(e){var s,t,i,n,h,o,l,f,g;this.index={version:1,documents:{}},this.fields=Array.isArray(e.fields)?e.fields.reduce((a,d)=>(a[d]=1,a),{}):e.fields,this.summary=e.summary,this.errorRate=(s=e.errorRate)!==null&&s!==void 0?s:1e-4,this.ngrams=(t=e.ngrams)!==null&&t!==void 0?t:1,this.minSize=(i=e.minSize)!==null&&i!==void 0?i:0,this.termFrequencyBuckets=(n=e.termFrequencyBuckets)!==null&&n!==void 0?n:[1,2,3,4,8,16,32,64],this.preprocess=(h=e.preprocess)!==null&&h!==void 0?h:String,this.stemmer=(o=e.stemmer)!==null&&o!==void 0?o:a=>a,this.stopwords=(l=e.stopwords)!==null&&l!==void 0?l:()=>!0,this.tokenizer=(f=e.tokenizer)!==null&&f!==void 0?f:Q,this.seed=(g=e.seed)!==null&&g!==void 0?g:12648430;const c=_(p(this.seed+1)),u=_(p(this.seed+2));this.hash=(a,d)=>c(d)+a*u(d)+a**3}load(e){if(e.version!==this.index.version)throw new Error(`incompatible index schema version ${e.version}, expected ${this.index.version}`);this.index.documents=v(e.documents).reduce((s,[t,i])=>(s[t]={summary:i.summary,signatures:v(i.signatures).reduce((n,[h,o])=>(n[h]=new S({...o,hash:this.hash}),n),{})},s),{})}add(e,s,t){var i,n;const h=w(this.fields).reduce((c,u)=>{if(s[u]!==void 0){const a=this.preprocess(s[u],u,s),d=this.tokenizer(a,t),y=d.filter(m=>m.length&&this.stopwords(m,t)).map(m=>this.stemmer(m,t)),M=E(2,this.ngrams+1).flatMap(m=>F(m,d).map(q=>q.join(" ")));c.set(u,y.concat(M))}return c},new Map),o=L(Array.from(h.values()).flat());if(o.length===0)return;const l={};for(const[c,u=1]of v(this.fields))for(const a of(i=h.get(c))!==null&&i!==void 0?i:[])l[a]=((n=l[a])!==null&&n!==void 0?n:0)+u;const f=Array.from(o).reduce((c,u)=>{var a;const d=(a=N(this.termFrequencyBuckets,y=>l[u]>=y))!==null&&a!==void 0?a:0;return c[d]||(c[d]=[]),c[d].push(u),c},{}),g=v(f).reduce((c,[u,a])=>{c[u]=new S({...j(Math.max(this.minSize,a.length),this.errorRate),seed:this.seed,hash:this.hash});for(const d of a)c[u].add(d);return c},{});this.index.documents[e]={summary:U(this.summary,s),signatures:g}}remove(e){delete this.index.documents[e]}search(e,s){const t=this.parseQuery(e,s),i=w(this.index.documents).length;return Object.values(this.index.documents).filter(n=>t.excluded.every(h=>!this.hasToken(n,h))&&t.required.every(h=>this.hasToken(n,h))).map(n=>{const h={};for(const o of t.included)h[o]=this.hasToken(n,o);return{summary:n.summary,matches:h}}).filter(({matches:n})=>Object.values(n).some(h=>h)).reduce((n,h,o,l)=>(n.push({...h,score:H(h.matches,l.map(({matches:f})=>f),i)}),n),[]).sort((n,h)=>P(n.score,h.score)).map(({summary:n})=>n)}hasToken(e,s){var t;return(t=w(e.signatures).find(i=>e.signatures[i].has(s)))!==null&&t!==void 0?t:0}parseQuery(e,s){return W(e).reduce(({required:t,included:i,excluded:n},[h,o])=>{const l=o===z?h:this.stemmer(h,s);return{required:[A,z].includes(o)?t.concat(l):t,included:o!==b?i.concat(l):i,excluded:o===b?n.concat(l):n}},{required:[],included:[],excluded:[]})}}export{J as B};
